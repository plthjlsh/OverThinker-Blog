---
import { getEntry, render } from "astro:content";

interface Props {
	class?: string;
}

const { class: className = "" } = Astro.props;

// è·å–ç«™ç‚¹é…ç½®ä¿¡æ¯
const siteTitle = import.meta.env.SITE_TITLE || "Overthinker-Blog";
const profileName = "Overthinker";
const bio = "è¿‡åº¦æ€è€ƒè€…ï¼Œæ­£åœ¨å°†å±å±±é›•ç¢æˆè‰ºæœ¯å“çš„è·¯ä¸Š...";

// è·å–å‹é“¾æ•°æ®
let friendsItems = [];
try {
	const friendsPost = await getEntry("spec", "friends");
	if (friendsPost) {
		const { Content } = await render(friendsPost);
		// æ³¨æ„ï¼šè¿™é‡Œçš„æ•°æ®æ˜¯ä» friends.astro é¡µé¢å¤åˆ¶çš„ï¼Œå› ä¸ºåœ¨å½“å‰æ–‡ä»¶ä¸­æ— æ³•ç›´æ¥è®¿é—®è¯¥æ–‡ä»¶çš„å˜é‡
		friendsItems = [
			{
				title: "Astro",
				imgurl: "https://avatars.githubusercontent.com/u/44914786?s=48&v=4",
				desc: "The web framework for content-driven websites. â­ï¸ Star to support our work!",
				siteurl: "https://github.com/withastro/astro",
				tags: ["Framework"],
			},
			{
				title: "N",
				imgurl: "/FriendsAvatar/n.jpg",
				desc: "Nçš„CSDNåšå®¢",
				siteurl: "https://blog.csdn.net/qq_46698164?type=blog",
				tags: ["Brother"],
			},
			{
				title: "OverThinker",
				imgurl: "/FriendsAvatar/K.jpg",
				desc: "Kçš„CSDNåšå®¢",
				siteurl: "https://blog.csdn.net/weixin_46491509?type=blog",
				tags: ["Me"],
			},
			{
				title: "æ¾ªè´°",
				imgurl: "/FriendsAvatar/æ¾ªè´°.jpg",
				desc: "æ¾ªè´°çš„ä¸ªäººåšå®¢",
				siteurl: "https://general.zzh-blog.club/",
				tags: ["Friend"],
			},
			{
				title: "CodeSuc",
				imgurl: "/FriendsAvatar/CodeSuc.jpg",
				desc: "CodeSucçš„CSDNåšå®¢",
				siteurl: "https://blog.csdn.net/weixin_63944437",
				tags: ["Friend"],
			},
		];
	}
} catch (e) {
	console.error("Failed to load friends data:", e);
	friendsItems = [];
}

// å°†å‹é“¾æ•°æ®è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ï¼Œä»¥ä¾¿åœ¨å®¢æˆ·ç«¯è„šæœ¬ä¸­ä½¿ç”¨
const friendsDataJson = JSON.stringify(friendsItems);
---

<div class={`bg-black rounded-xl p-4 shadow-lg font-mono text-sm ${className}`}>
  <div class="flex items-center mb-2">
    <div class="flex space-x-2">
      <div class="w-3 h-3 bg-red-500 rounded-full"></div>
      <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
      <div class="w-3 h-3 bg-green-500 rounded-full"></div>
    </div>
    <div class="ml-2 text-[var(--text-color)] text-xs">terminal</div>
  </div>
  
  <div id="terminal-output" class="mb-2 h-40 overflow-y-auto text-[var(--text-color)] bg-black" style="overflow-x: hidden; scrollbar-width: none; -ms-overflow-style: none;">
    <div class="mb-1">$ Welcome to {siteTitle} Terminal Emulator</div>
    <div class="mb-1">$ Type 'help' to see available commands</div>
  </div>
  
  <div class="flex items-center bg-black">
    <span class="text-green-500 mr-2">$</span>
    <input 
      id="terminal-input" 
      type="text" 
      class="flex-1 bg-black outline-none text-[var(--text-color)]"
      placeholder="Type a command..."
    />
  </div>
</div>

<style>
  #terminal-output::-webkit-scrollbar {
    display: none;
  }
</style>

<!-- éšè—çš„å‹é“¾æ•°æ®å…ƒç´ ï¼Œä¾›å®¢æˆ·ç«¯è„šæœ¬è¯»å– -->
<div id="friends-data" style="display: none;" data-friends={friendsDataJson}></div>

<script>
  // å®¢æˆ·ç«¯è„šæœ¬ï¼Œåœ¨æµè§ˆå™¨ä¸­è¿è¡Œ
  if (typeof window !== 'undefined') {
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('terminal-input');
      const output = document.getElementById('terminal-output');
      
      // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
      input?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const command = input.value.trim();
          
          // æ˜¾ç¤ºç”¨æˆ·è¾“å…¥çš„å‘½ä»¤
          const commandLine = document.createElement('div');
          commandLine.className = 'mb-1';
          commandLine.innerHTML = `<span class="text-green-500">$</span> ${command}`;
          output.appendChild(commandLine);
          
          // å¤„ç†å‘½ä»¤ (å¤§å°å†™ä¸æ•æ„Ÿ)
          const lowerCommand = command.toLowerCase();
          if (lowerCommand === 'help') {
            const helpText = document.createElement('div');
            helpText.className = 'mb-1';
            helpText.innerHTML = `
              Available commands:<br>
              &nbsp;&nbsp;<span class="text-blue-400">help</span> - Show this help message<br>
              &nbsp;&nbsp;<span class="text-blue-400">ls</span> - List articles<br>
              &nbsp;&nbsp;<span class="text-blue-400">whoami</span> - Show your profile<br>
              &nbsp;&nbsp;<span class="text-blue-400">visit</span> - Get blog friends/recommended sites<br>
              &nbsp;&nbsp;<span class="text-blue-400">chatroom</span> - Access the chatroom<br>
              &nbsp;&nbsp;<span class="text-blue-400">hack</span> - Secret command<br>
              &nbsp;&nbsp;<span class="text-blue-400">clear</span> - Clear terminal
            `;
            output.appendChild(helpText);
          } else if (lowerCommand === 'ls') {
            const lsText = document.createElement('div');
            lsText.className = 'mb-1';
            lsText.innerHTML = `
              Articles:<br>
              &nbsp;&nbsp;- ğŸŒŸ:-Dç®€å•è‡ªæˆ‘ä»‹ç»ä¸€ä¸‹<br>
              &nbsp;&nbsp;- Javaç³»åˆ—æ•™ç¨‹<br>
              &nbsp;&nbsp;- æ•°æ®ç»“æ„ç³»åˆ—æ•™ç¨‹<br>
              &nbsp;&nbsp;- ç”Ÿæ´»éšç¬”<br>
              &nbsp;&nbsp;- èŠå¤©å®¤å¼€å‘è®°å½•<br>
              &nbsp;&nbsp;- Markdownä½¿ç”¨æŒ‡å—
            `;
            output.appendChild(lsText);
          } else if (lowerCommand === 'whoami') {
            const whoamiText = document.createElement('div');
            whoamiText.className = 'mb-1';
            whoamiText.innerHTML = `
              User Information:<br>
              &nbsp;&nbsp;Username: <span class="text-purple-400">Overthinker</span><br>
              &nbsp;&nbsp;Role: <span class="text-yellow-400">Developer & Blogger</span><br>
              &nbsp;&nbsp;Bio: è¿‡åº¦æ€è€ƒè€…ï¼Œæ­£åœ¨å°†å±å±±é›•ç¢æˆè‰ºæœ¯å“çš„è·¯ä¸Š...<br>
              &nbsp;&nbsp;Motto: "æ— æ‰€è°“ï¼Œè·³æ¢æˆˆä¸åƒäººç”Ÿï¼Œä¸€æ­¥è·³é”™äº†ï¼Œç»§ç»­è·³å°±è¡Œäº†"
            `;
            output.appendChild(whoamiText);
          } else if (lowerCommand === 'hack') {
            // å½©è›‹åŠŸèƒ½ï¼šå…¨å±é—ªçƒæ•ˆæœ
            const hackText = document.createElement('div');
            hackText.className = 'mb-1';
            hackText.innerHTML = '<span class="text-red-500">[SYSTEM ALERT] Initiating system hack sequence...</span>';
            output.appendChild(hackText);
            
            // åˆ›å»ºå…¨å±é—ªçƒæ•ˆæœ
            const overlay = document.createElement('div');
            overlay.id = 'hack-overlay';
            overlay.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: #00ff00;
              z-index: 9999;
              opacity: 0;
              pointer-events: none;
            `;
            document.body.appendChild(overlay);
            
            // æ‰§è¡Œé—ªçƒåŠ¨ç”»
            let intensity = 0;
            const flashInterval = setInterval(() => {
              intensity += 0.1;
              overlay.style.opacity = Math.abs(Math.sin(intensity)).toString();
              
              if (intensity > Math.PI * 2) {
                clearInterval(flashInterval);
                setTimeout(() => {
                  document.body.removeChild(overlay);
                  
                  const successText = document.createElement('div');
                  successText.className = 'mb-1';
                  successText.innerHTML = '<span class="text-green-500">[HACK COMPLETE] System security bypassed!</span>';
                  output.appendChild(successText);
                  
                  // æ»šåŠ¨åˆ°åº•éƒ¨
                  output.scrollTop = output.scrollHeight;
                }, 500);
              }
            }, 50);
          } else if (lowerCommand === 'visit') {
            // ä»éšè—å…ƒç´ ä¸­è·å–å‹é“¾æ•°æ®
            const friendsDataElement = document.getElementById('friends-data');
            let friendsData = [];
            if (friendsDataElement) {
              try {
                const friendsDataJson = friendsDataElement.getAttribute('data-friends');
                friendsData = JSON.parse(friendsDataJson);
              } catch (e) {
                console.error('Failed to parse friends data:', e);
              }
            }
            
            // ç”Ÿæˆå‹é“¾åˆ—è¡¨
            let friendsList = 'Blog Friends/Recommended Sites:<br>';
            if (friendsData.length > 0) {
              friendsData.forEach((friend, index) => {
                friendsList += `&nbsp;&nbsp;<span class="text-green-400">${friend.title}</span> - ${friend.desc}<br>`;
              });
            } else {
              friendsList += '&nbsp;&nbsp;No friends data available.<br>';
            }
            friendsList += '<br>&nbsp;&nbsp;Use <span class="text-blue-400">visit [sitename]</span> for more details (coming soon)';
            
            const visitText = document.createElement('div');
            visitText.className = 'mb-1';
            visitText.innerHTML = friendsList;
            output.appendChild(visitText);
          } else if (lowerCommand === 'chatroom') {
            const chatroomText = document.createElement('div');
            chatroomText.className = 'mb-1';
            chatroomText.innerHTML = `
              Chatroom Access:<br>
              &nbsp;&nbsp;Click the link below to access the chatroom:<br>
              &nbsp;&nbsp;<a href="http://114.132.122.97:8080/login.html" target="_blank" class="text-blue-400 underline">
                http://114.132.122.97:8080/login.html
              </a>
            `;
            output.appendChild(chatroomText);
          } else if (lowerCommand === 'clear') {
            output.innerHTML = '';
          } else if (command === '') {
            // ç©ºå‘½ä»¤ä¸å¤„ç†
          } else {
            const errorText = document.createElement('div');
            errorText.className = 'mb-1 text-red-500';
            errorText.textContent = `Command not found: ${command}. Type 'help' for available commands.`;
            output.appendChild(errorText);
          }
          
          // æ¸…ç©ºè¾“å…¥æ¡†
          input.value = '';
          
          // æ»šåŠ¨åˆ°åº•éƒ¨
          output.scrollTop = output.scrollHeight;
        }
      });
    });
  }
</script>